<!-- 个人信息模块 -->
<div id="profile" class="dashboard-section">
    <div class="profile-container" style="padding: 20px;">
        <div class="profile-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="margin: 0; font-size: 24px; font-weight: 600; color: #111827;">个人信息</h1>
            <button id="save-profile" class="btn btn-primary" style="padding: 8px 16px; background-color: #6366F1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-save"></i> 保存修改
            </button>
        </div>
        
        <div class="profile-content" style="display: grid; grid-template-columns: 250px 1fr; gap: 30px;">
            <!-- 左侧：头像和基本信息 -->
            <div class="profile-sidebar">
                <div class="profile-avatar" style="text-align: center; margin-bottom: 20px;">
                    <div style="width: 150px; height: 150px; margin: 0 auto; background-color: #E5E7EB; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 60px; color: #9CA3AF;">
                        <i class="fas fa-user"></i>
                    </div>
                    <button id="change-avatar" style="margin-top: 10px; padding: 6px 12px; background-color: #F3F4F6; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                        <i class="fas fa-camera"></i> 更换头像
                    </button>
                </div>
                
                <div class="profile-info" style="background-color: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                    <div class="info-item" style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">用户名</div>
                        <div id="profile-username" style="font-weight: 500; color: #111827;">加载中...</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">角色</div>
                        <div id="profile-role" style="font-weight: 500; color: #111827;">加载中...</div>
                    </div>
                    <div class="info-item" style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">账号创建时间</div>
                        <div id="profile-created" style="font-weight: 500; color: #111827;">加载中...</div>
                    </div>
                    <div class="info-item">
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">最后登录时间</div>
                        <div id="profile-last-login" style="font-weight: 500; color: #111827;">加载中...</div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：详细信息和设置 -->
            <div class="profile-details">
                <div class="profile-tabs" style="margin-bottom: 20px;">
                    <ul class="tabs" style="display: flex; list-style: none; padding: 0; margin: 0; border-bottom: 1px solid #E5E7EB;">
                        <li class="tab-item" style="margin-right: 20px;">
                            <a href="#basic-info" class="active" style="display: block; padding: 10px 0; color: #6366F1; font-weight: 500; text-decoration: none; border-bottom: 2px solid #6366F1;">基本信息</a>
                        </li>
                        <li class="tab-item" style="margin-right: 20px;">
                            <a href="#security" style="display: block; padding: 10px 0; color: #6B7280; font-weight: 500; text-decoration: none;">安全设置</a>
                        </li>
                        <li class="tab-item">
                            <a href="#preferences" style="display: block; padding: 10px 0; color: #6B7280; font-weight: 500; text-decoration: none;">个人偏好</a>
                        </li>
                    </ul>
                </div>
                
                <div class="tab-content">
                    <!-- 基本信息标签页 -->
                    <div id="basic-info" class="tab-pane active" style="background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <form id="basic-info-form">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="display-name" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">显示名称</label>
                                <input type="text" id="display-name" name="display-name" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;" placeholder="请输入您的显示名称">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="email" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">电子邮箱</label>
                                <input type="email" id="email" name="email" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;" placeholder="请输入您的电子邮箱" readonly>
                                <div style="margin-top: 4px; font-size: 12px; color: #6B7280;">邮箱地址不可修改，如需更改请联系管理员</div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="phone" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">手机号码</label>
                                <input type="tel" id="phone" name="phone" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;" placeholder="请输入您的手机号码">
                            </div>
                            
                            <div class="form-group">
                                <label for="bio" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">个人简介</label>
                                <textarea id="bio" name="bio" rows="4" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px; resize: vertical;" placeholder="请输入您的个人简介"></textarea>
                            </div>
                        </form>
                    </div>
                    
                    <!-- 安全设置标签页 -->
                    <div id="security" class="tab-pane" style="display: none; background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <form id="security-form">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="current-password" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">当前密码</label>
                                <input type="password" id="current-password" name="current-password" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;" placeholder="请输入当前密码">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="new-password" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">新密码</label>
                                <input type="password" id="new-password" name="new-password" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;" placeholder="请输入新密码">
                                <div style="margin-top: 4px; font-size: 12px; color: #6B7280;">密码长度至少为8位，包含字母和数字</div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="confirm-password" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">确认新密码</label>
                                <input type="password" id="confirm-password" name="confirm-password" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;" placeholder="请再次输入新密码">
                            </div>
                            
                            <button type="button" id="change-password-btn" style="padding: 10px 16px; background-color: #6366F1; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                更改密码
                            </button>
                        </form>
                    </div>
                    
                    <!-- 个人偏好标签页 -->
                    <div id="preferences" class="tab-pane" style="display: none; background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <form id="preferences-form">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">界面主题</label>
                                <div style="display: flex; gap: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="theme" value="light" checked style="margin-right: 8px;">
                                        <span>浅色</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="theme" value="dark" style="margin-right: 8px;">
                                        <span>深色</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="theme" value="system" style="margin-right: 8px;">
                                        <span>跟随系统</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">通知设置</label>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="notification-email" checked style="margin-right: 8px;">
                                        <span>接收邮件通知</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="notification-browser" checked style="margin-right: 8px;">
                                        <span>接收浏览器通知</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" name="notification-mobile" style="margin-right: 8px;">
                                        <span>接收手机通知</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="language" style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">语言偏好</label>
                                <select id="language" name="language" style="width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 14px;">
                                    <option value="zh-CN" selected>简体中文</option>
                                    <option value="en-US">English (US)</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Profile 模块加载完成');
        
        // 加载用户信息
        loadUserProfile();
        
        // 标签页切换
        const tabLinks = document.querySelectorAll('.profile-tabs .tab-item a');
        const tabPanes = document.querySelectorAll('.tab-content .tab-pane');
        
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 移除所有活动状态
                tabLinks.forEach(l => {
                    l.classList.remove('active');
                    l.style.color = '#6B7280';
                    l.style.borderBottom = 'none';
                });
                
                // 隐藏所有标签页
                tabPanes.forEach(pane => {
                    pane.style.display = 'none';
                    pane.classList.remove('active');
                });
                
                // 激活当前标签页
                this.classList.add('active');
                this.style.color = '#6366F1';
                this.style.borderBottom = '2px solid #6366F1';
                
                const target = this.getAttribute('href').substring(1);
                const targetPane = document.getElementById(target);
                targetPane.style.display = 'block';
                targetPane.classList.add('active');
            });
        });
        
        // 保存个人信息
        document.getElementById('save-profile').addEventListener('click', function() {
            saveUserProfile();
        });
        
        // 更改密码
        document.getElementById('change-password-btn').addEventListener('click', function() {
            changePassword();
        });
        
        // 更换头像
        document.getElementById('change-avatar').addEventListener('click', function() {
            alert('头像更换功能正在开发中...');
        });
    });
    
    // 加载用户信息
    async function loadUserProfile() {
        try {
            // 获取当前用户
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            
            if (userError) throw userError;
            
            if (!user) {
                throw new Error('未登录，请先登录');
            }
            
            // 获取用户资料
            const { data: profile, error: profileError } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('user_id', user.id)
                .single();
                
            if (profileError && profileError.code !== 'PGRST116') {
                throw profileError;
            }
            
            // 填充基本信息
            document.getElementById('profile-username').textContent = profile?.username || user.email.split('@')[0];
            document.getElementById('profile-role').textContent = profile?.role ? getRoleName(profile.role) : '普通用户';
            document.getElementById('profile-created').textContent = formatDate(user.created_at);
            document.getElementById('profile-last-login').textContent = formatDate(user.last_sign_in_at) || '未知';
            
            // 填充表单
            document.getElementById('display-name').value = profile?.username || user.email.split('@')[0];
            document.getElementById('email').value = user.email;
            document.getElementById('phone').value = profile?.phone || '';
            document.getElementById('bio').value = profile?.bio || '';
            
        } catch (error) {
            console.error('加载用户信息失败:', error);
            alert('加载用户信息失败: ' + error.message);
        }
    }
    
    // 保存用户信息
    async function saveUserProfile() {
        try {
            // 获取当前用户
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            
            if (userError) throw userError;
            
            if (!user) {
                throw new Error('未登录，请先登录');
            }
            
            // 获取表单数据
            const displayName = document.getElementById('display-name').value;
            const phone = document.getElementById('phone').value;
            const bio = document.getElementById('bio').value;
            
            // 更新用户资料
            const { error: updateError } = await supabase
                .from('user_profiles')
                .upsert({
                    user_id: user.id,
                    username: displayName,
                    phone: phone,
                    bio: bio,
                    updated_at: new Date().toISOString()
                });
                
            if (updateError) throw updateError;
            
            // 更新显示
            document.getElementById('profile-username').textContent = displayName;
            
            alert('个人信息保存成功');
            
        } catch (error) {
            console.error('保存用户信息失败:', error);
            alert('保存用户信息失败: ' + error.message);
        }
    }
    
    // 更改密码
    async function changePassword() {
        try {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                throw new Error('请填写所有密码字段');
            }
            
            if (newPassword !== confirmPassword) {
                throw new Error('两次输入的新密码不一致');
            }
            
            if (newPassword.length < 8) {
                throw new Error('新密码长度至少为8位');
            }
            
            // 更新密码
            const { error } = await supabase.auth.updateUser({
                password: newPassword
            });
            
            if (error) throw error;
            
            // 清空表单
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            alert('密码修改成功');
            
        } catch (error) {
            console.error('修改密码失败:', error);
            alert('修改密码失败: ' + error.message);
        }
    }
    
    // 格式化日期
    function formatDate(dateString) {
        if (!dateString) return '';
        
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // 获取角色名称
    function getRoleName(role) {
        const roleMap = {
            'SUPER_ADMIN': '超级管理员',
            'STORE_ADMIN': '门店管理员',
            'STORE_EMPLOYEE': '门店员工'
        };
        
        return roleMap[role] || '普通用户';
    }
</script> 